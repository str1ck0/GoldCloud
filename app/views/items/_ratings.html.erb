<div class="mt-5">
	<div class="pb-3 border-bottom d-flex justify-content-between align-items-center">
		<h3 class="mb-0"><%= item.itemable_type %> Reviews</h3>
		<% user_rating = current_user&.ratings&.find_by(item: item) %>
		<% can_rate = current_user&.orders&.delivered&.joins(:order_items)&.where(order_items: { itemable: item.itemable })&.exists? %>
		<% if can_rate %>
			<% if user_rating %>
				<%= link_to "Edit your review", "#", class: "text-warning", data: { bs_toggle: "modal", bs_target: "#reviewModal" } %>
			<% else %>
				<%= link_to "Add a review", "#", class: "text-success", data: { bs_toggle: "modal", bs_target: "#reviewModal" } %>
			<% end %>
		<% end %>
	</div>

	<% visible_ratings = current_user&.role == "admin" ? @item.ratings : @item.ratings.where(hidden: false) %>
	<% if visible_ratings.count == 0 %>
		<p class="text-white-50 mt-3">No reviews yet...</p>
	<% else %>
		<% visible_ratings.each do |rating| %>
			<div class="rating-card border-bottom py-3 d-flex justify-content-between<%= ' opacity-50' if rating.hidden && current_user&.role == 'admin' %>">
				<div>
					<p class="mb-1 fw-bold">
						<%= rating.user.username %>
						<% if rating.hidden && current_user&.role == "admin" %>
							<span class="badge bg-secondary ms-2">Hidden</span>
						<% end %>
					</p>
					<div class="rating mb-2">
						<% rating.score.times do %>
							<i class="bi bi-star-fill text-warning"></i>
						<% end %>
						<% (5 - rating.score.to_i).times do %>
							<i class="bi bi-star text-warning"></i>
						<% end %>
					</div>
					<p class="m-0 text-white-50"><%= rating.comment %></p>
				</div>

				<div class="d-flex flex-column justify-content-between">
					<p class="text-white-50"><small><%= time_ago_in_words(rating.created_at) %> ago</small></p>
					<% if current_user&.role == "admin" %>
						<div class="ms-auto">
							<% if rating.hidden %>
								<%= link_to "Unhide", unhide_rating_path(rating), class: "btn btn-sm btn-success", data: { turbo_method: :patch, turbo_confirm: "Are you sure you want to unhide this rating?" } %>
							<% else %>
								<%= link_to "Hide", rating_path(rating), class: "btn btn-sm btn-danger", data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to hide this rating? Hidden ratings can be unhidden later." } %>
							<% end %>
						</div>
					<% end %>
				</div>
			</div>
		<% end %>
	<% end %>

	<% if can_rate %>
		<!-- Review Modal -->
		<div class="modal fade" data-bs-theme="dark" id="reviewModal" data-controller="review-modal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					
					<div class="modal-header">
						<h5 class="modal-title" id="reviewModalLabel">
							<% if user_rating %>
								Edit Your Review for <%= @item.itemable.name %>
							<% else %>
								Add Your Review for <%= @item.itemable.name %>
							<% end %>
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>

					<%= form_with(model: Rating.new, local: true) do |f| %>
						<div class="modal-body">
							<%= f.hidden_field :item_id, value: item.id %>
							<%= f.hidden_field :score, value: user_rating&.score, data: { review_modal_target: "scoreInput" } %>
							
							<div class="mb-3">
								<label class="form-label">Rating</label>
								<div class="star-rating">
									<% 5.times do |i| %>
										<i class="bi bi-star<%= (user_rating&.score && i < user_rating.score) ? '-fill' : '' %> fs-3 text-warning" 
											data-value="<%= i+1 %>" 
											data-action="click->review-modal#setRating"
											data-review-modal-target="star"></i>
									<% end %>
								</div>
								<div class="text-danger mt-1" data-review-modal-target="ratingError" style="display: none;">
									Please select a rating
								</div>
							</div>

							<div class="mb-3">
								<%= f.label :comment, "Your Review", class: "form-label" %>
								<%= f.text_area :comment, value: user_rating&.comment, class: "form-control", rows: 4, required: true %>
							</div>
						</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							<%= f.submit (user_rating ? "Update Review" : "Submit Review"), class: "btn btn-primary", data: { action: "click->review-modal#validateRating" } %>
						</div>
					<% end %>
				</div>
			</div>
		</div>
	<% end %>

</div>